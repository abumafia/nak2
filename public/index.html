<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nakrutka Servislari</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .hidden {
            display: none;
        }
        
        .step-progress {
            transition: all 0.3s ease;
        }
        
        .step-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .step-completed {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .card-hover {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .service-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .service-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .service-card.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
        }
        
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        
        @keyframes modalEnter {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-5 shadow-xl">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    <i class="fas fa-rocket text-purple-600 text-xl"></i>
                </div>
                <h1 class="text-2xl font-bold">Nakrutka Servislari</h1>
            </div>
            <button id="historyBtn" class="bg-white text-purple-600 hover:bg-purple-50 px-5 py-2.5 rounded-xl transition-all duration-300 font-semibold shadow-lg hover:shadow-xl flex items-center space-x-2">
                <i class="fas fa-history"></i>
                <span>Buyurtmalar Tarixi</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Progress Steps -->
        <div class="max-w-3xl mx-auto mb-12">
            <div class="flex justify-between items-center relative">
                <!-- Progress Line -->
                <div class="absolute top-5 left-0 right-0 h-1 bg-gray-200 -z-10">
                    <div id="progressLine" class="h-1 bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500" style="width: 0%"></div>
                </div>
                
                <!-- Step 1 -->
                <div class="step flex flex-col items-center relative z-10">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 text-white flex items-center justify-center font-bold step-active shadow-lg step-progress" id="step1">
                        <i class="fas fa-list"></i>
                    </div>
                    <span class="mt-3 text-sm font-semibold text-gray-800">Servis Tanlash</span>
                </div>
                
                <!-- Step 2 -->
                <div class="step flex flex-col items-center relative z-10">
                    <div class="w-12 h-12 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold shadow-lg step-progress" id="step2">
                        <i class="fas fa-edit"></i>
                    </div>
                    <span class="mt-3 text-sm font-medium text-gray-500">Buyurtma Ma'lumotlari</span>
                </div>
                
                <!-- Step 3 -->
                <div class="step flex flex-col items-center relative z-10">
                    <div class="w-12 h-12 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold shadow-lg step-progress" id="step3">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <span class="mt-3 text-sm font-medium text-gray-500">To'lov</span>
                </div>
            </div>
        </div>

        <!-- Step 1: Servis Tanlash -->
        <div id="step1-content" class="max-w-4xl mx-auto fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Servis Tanlang</h2>
                    <p class="text-gray-600">Kerakli kategoriyani tanlab, servisingizni buyurtma bering</p>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-layer-group text-blue-500 mr-2"></i>
                        Kategoriyalar
                    </h3>
                    <div id="loadingCategories" class="text-center py-8">
                        <div class="loading mx-auto mb-2"></div>
                        <p class="text-gray-500">Kategoriyalar yuklanmoqda...</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden" id="categories">
                        <!-- Kategoriyalar dinamik ravishda yuklanadi -->
                    </div>
                    <div id="categoriesError" class="text-center py-8 hidden">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-3"></i>
                        <p class="text-gray-600">Kategoriyalarni yuklashda xato yuz berdi</p>
                        <button onclick="loadCategories()" class="mt-3 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Qayta Urinish</button>
                    </div>
                </div>

                <div id="services-section" class="hidden animate__animated animate__fadeIn">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-cogs text-purple-500 mr-2"></i>
                        Mavjud Servislar
                    </h3>
                    <div id="loadingServices" class="text-center py-8 hidden">
                        <div class="loading mx-auto mb-2"></div>
                        <p class="text-gray-500">Servislar yuklanmoqda...</p>
                    </div>
                    <div id="services" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Servislar dinamik ravishda yuklanadi -->
                    </div>
                    <div id="servicesError" class="text-center py-8 hidden">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-3"></i>
                        <p class="text-gray-600">Servislarni yuklashda xato yuz berdi</p>
                        <button onclick="loadServicesByCategory(selectedCategory)" class="mt-3 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Qayta Urinish</button>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <button id="nextToStep2" class="btn-primary text-white px-8 py-3 rounded-xl font-semibold text-lg hidden pulse-animation">
                        Keyingi Qadam <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Buyurtma Ma'lumotlari -->
        <div id="step2-content" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8 border border-gray-100 hidden fade-in">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Buyurtma Ma'lumotlari</h2>
                <p class="text-gray-600">Buyurtmangiz uchun kerakli ma'lumotlarni kiriting</p>
            </div>

            <div class="mb-6 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-100">
                <h3 class="font-semibold text-lg text-gray-800 mb-2 flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    Tanlangan Servis:
                </h3>
                <p id="selected-service-info" class="text-gray-700 text-lg"></p>
                <p id="selected-service-price" class="text-xl font-bold text-blue-600 mt-1"></p>
            </div>

            <div class="space-y-6">
                <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-link text-blue-500 mr-2"></i>
                        Profil Manzili
                    </label>
                    <input type="text" id="profileUrl" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="https://instagram.com/foydalanuvchi">
                </div>
                
                <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-hashtag text-purple-500 mr-2"></i>
                        Miqdor
                    </label>
                    <input type="number" id="quantity" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="100" min="1">
                </div>

                <div class="p-5 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                    <h3 class="font-semibold text-yellow-800 text-lg mb-2 flex items-center">
                        <i class="fas fa-calculator text-yellow-600 mr-2"></i>
                        Umumiy To'lov Miqdori:
                    </h3>
                    <p id="total-amount" class="text-3xl font-bold text-yellow-700">0 so'm</p>
                </div>
            </div>

            <div class="flex justify-between mt-8">
                <button id="backToStep1" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-8 py-3 rounded-xl font-semibold text-lg transition-all duration-300 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Orqaga
                </button>
                <button id="nextToStep3" class="btn-primary text-white px-8 py-3 rounded-xl font-semibold text-lg flex items-center">
                    To'lovga O'tish <i class="fas fa-credit-card ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Step 3: To'lov -->
        <div id="step3-content" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8 border border-gray-100 hidden fade-in">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">To'lov Qilish</h2>
                <p class="text-gray-600">Buyurtmangizni yakunlash uchun to'lov qiling</p>
            </div>
            
            <div class="mb-6 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-100">
                <h3 class="font-semibold text-lg text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-clipboard-list text-blue-500 mr-2"></i>
                    Buyurtma Tafsilotlari:
                </h3>
                <p id="order-summary" class="text-gray-700 text-lg"></p>
                <p id="order-total" class="text-2xl font-bold text-blue-600 mt-2"></p>
            </div>

            <div class="mb-6 p-6 bg-gradient-to-r from-green-50 to-teal-50 rounded-xl border border-green-200">
                <h3 class="font-semibold text-green-800 text-lg mb-3 flex items-center">
                    <i class="fas fa-info-circle text-green-600 mr-2"></i>
                    To'lov Ma'lumotlari:
                </h3>
                <p class="text-gray-700 mb-3">Quyidagi hisob raqamiga to'lov qiling:</p>
                <div class="mt-3 p-4 bg-white rounded-xl border border-green-200 shadow-sm">
                    <div class="space-y-2">
                        <p class="font-medium flex items-center"><i class="fas fa-university text-green-500 mr-2"></i> Bank: Ipak Yuli Bank</p>
                        <p class="font-medium flex items-center"><i class="fas fa-credit-card text-green-500 mr-2"></i> Karta Raqami: 5614 6887 0520 2686</p>
                        <p class="font-medium flex items-center"><i class="fas fa-user text-green-500 mr-2"></i> Ism: Qoryogdiyev Abdurahmon</p>
                    </div>
                </div>
                <p class="mt-3 text-sm text-gray-600 flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                    Yuqorida ko'rsatilgan umumiy summani to'liq to'laganingizga ishonch hosil qiling.
                </p>
            </div>

            <div class="space-y-6">
                <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-receipt text-purple-500 mr-2"></i>
                        To'lov Skrinshotini Yuklang
                    </label>
                    <input type="file" id="paymentScreenshot" class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" accept="image/*">
                    <p class="text-xs text-gray-500 mt-2 flex items-center">
                        <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                        Format: JPG, PNG (Maks. 2MB)
                    </p>
                </div>
                
                <div id="preview-container" class="hidden mt-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-eye text-blue-500 mr-2"></i>
                        Oldindan Ko'rish:
                    </p>
                    <img id="preview-image" class="max-w-xs mt-2 rounded-xl border-2 border-gray-300 shadow-md">
                </div>
            </div>

            <div class="flex justify-between mt-8">
                <button id="backToStep2" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-8 py-3 rounded-xl font-semibold text-lg transition-all duration-300 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Orqaga
                </button>
                <button id="submitOrder" class="btn-success text-white px-8 py-3 rounded-xl font-semibold text-lg flex items-center pulse-animation">
                    <i class="fas fa-paper-plane mr-2"></i> Buyurtmani Yuborish
                </button>
            </div>
        </div>
    </main>

    <!-- Modal: Buyurtmalar Tarixi -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[85vh] overflow-hidden modal-enter">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-gradient-to-r from-blue-500 to-purple-500 text-white">
                <h3 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-history mr-3"></i>
                    Buyurtmalar Tarixi
                </h3>
                <button id="closeHistoryModal" class="text-white hover:text-gray-200 text-xl transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div id="loadingHistory" class="text-center py-8">
                    <div class="loading mx-auto mb-2"></div>
                    <p class="text-gray-500">Buyurtmalar yuklanmoqda...</p>
                </div>
                <div id="historyList" class="space-y-4 hidden">
                    <!-- Buyurtmalar tarixi dinamik ravishda yuklanadi -->
                </div>
                <div id="historyError" class="text-center py-8 hidden">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-3"></i>
                    <p class="text-gray-600">Buyurtmalarni yuklashda xato yuz berdi</p>
                    <button onclick="showHistory()" class="mt-3 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Qayta Urinish</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Muvaffaqiyat -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center modal-enter">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 floating">
                <i class="fas fa-check text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-3">Buyurtma Muvaffaqiyatli!</h3>
            <p class="text-gray-600 mb-6">Buyurtmangiz qabul qilindi va admin tasdiqini kutmoqda. Tez orada siz bilan bog'lanamiz.</p>
            <button id="closeSuccessModal" class="btn-primary text-white px-8 py-3 rounded-xl font-semibold text-lg w-full">
                Yopish
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-gray-800 to-gray-900 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" class="text-gray-300 hover:text-white transition-colors">
                    <i class="fab fa-telegram text-2xl"></i>
                </a>
                <a href="#" class="text-gray-300 hover:text-white transition-colors">
                    <i class="fab fa-instagram text-2xl"></i>
                </a>
                <a href="#" class="text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-envelope text-2xl"></i>
                </a>
            </div>
            <p class="text-gray-400">&copy; 2024 Nakrutka Servislari. Barcha huquqlar himoyalangan.</p>
        </div>
    </footer>

    <script>
        // Dastur holati
        let currentStep = 1;
        let selectedCategory = null;
        let selectedService = null;
        let servicesData = [];

        // DOM Elementlari
        const step1Content = document.getElementById('step1-content');
        const step2Content = document.getElementById('step2-content');
        const step3Content = document.getElementById('step3-content');
        const categoriesContainer = document.getElementById('categories');
        const servicesSection = document.getElementById('services-section');
        const servicesContainer = document.getElementById('services');
        const nextToStep2Btn = document.getElementById('nextToStep2');
        const nextToStep3Btn = document.getElementById('nextToStep3');
        const backToStep1Btn = document.getElementById('backToStep1');
        const backToStep2Btn = document.getElementById('backToStep2');
        const submitOrderBtn = document.getElementById('submitOrder');
        const historyBtn = document.getElementById('historyBtn');
        const historyModal = document.getElementById('historyModal');
        const closeHistoryModal = document.getElementById('closeHistoryModal');
        const successModal = document.getElementById('successModal');
        const closeSuccessModal = document.getElementById('closeSuccessModal');
        const progressLine = document.getElementById('progressLine');

        // Event Listenerlar
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            setupEventListeners();
        });

        function setupEventListeners() {
            nextToStep2Btn.addEventListener('click', goToStep2);
            nextToStep3Btn.addEventListener('click', goToStep3);
            backToStep1Btn.addEventListener('click', goToStep1);
            backToStep2Btn.addEventListener('click', goToStep2FromStep3);
            submitOrderBtn.addEventListener('click', submitOrder);
            historyBtn.addEventListener('click', showHistory);
            closeHistoryModal.addEventListener('click', () => historyModal.classList.add('hidden'));
            closeSuccessModal.addEventListener('click', () => {
                successModal.classList.add('hidden');
                resetForm();
            });

            // Rasm yuklash
            document.getElementById('paymentScreenshot').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Fayl hajmini tekshirish
                    if (file.size > 2 * 1024 * 1024) {
                        alert('Fayl hajmi 2MB dan kichik bo\'lishi kerak');
                        this.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('preview-image').src = event.target.result;
                        document.getElementById('preview-container').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Umumiy summani hisoblash
            document.getElementById('quantity').addEventListener('input', calculateTotal);
        }

        // Kategoriyalarni yuklash
        async function loadCategories() {
            try {
                document.getElementById('loadingCategories').classList.remove('hidden');
                document.getElementById('categories').classList.add('hidden');
                document.getElementById('categoriesError').classList.add('hidden');

                const response = await fetch('https://nakrutka-uz.onrender.com/api/services');
                if (!response.ok) {
                    throw new Error('Server xatosi');
                }
                
                servicesData = await response.json();
                
                // Kategoriyalarni ajratib olish
                const categories = [...new Set(servicesData.map(service => service.category))];
                
                document.getElementById('loadingCategories').classList.add('hidden');
                categoriesContainer.classList.remove('hidden');
                
                categoriesContainer.innerHTML = '';
                categories.forEach(category => {
                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'card-hover bg-white border border-gray-200 rounded-xl p-6 text-center cursor-pointer transition-all duration-300';
                    categoryElement.innerHTML = `
                        <div class="w-16 h-16 bg-gradient-to-r from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-hashtag text-blue-500 text-2xl"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 text-lg">${category}</h3>
                        <p class="text-gray-500 text-sm mt-2">${servicesData.filter(s => s.category === category).length} ta servis</p>
                    `;
                    categoryElement.addEventListener('click', () => selectCategory(category));
                    categoriesContainer.appendChild(categoryElement);
                });
            } catch (error) {
                console.error('Kategoriyalarni yuklashda xato:', error);
                document.getElementById('loadingCategories').classList.add('hidden');
                document.getElementById('categoriesError').classList.remove('hidden');
            }
        }

        // Kategoriyani tanlash
        function selectCategory(category) {
            selectedCategory = category;
            servicesSection.classList.remove('hidden');
            nextToStep2Btn.classList.remove('hidden');
            
            // Tanlangan kategoriyani ajratib ko'rsatish
            document.querySelectorAll('#categories > div').forEach(el => {
                el.classList.remove('border-blue-500', 'bg-blue-50');
            });
            event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
            
            // Kategoriya bo'yicha servislarni yuklash
            loadServicesByCategory(category);
        }

        // Kategoriya bo'yicha servislarni yuklash
        async function loadServicesByCategory(category) {
            try {
                document.getElementById('loadingServices').classList.remove('hidden');
                document.getElementById('services').classList.add('hidden');
                document.getElementById('servicesError').classList.add('hidden');

                const response = await fetch(`https://nakrutka-uz.onrender.com/api/services/${encodeURIComponent(category)}`);
                if (!response.ok) {
                    throw new Error('Server xatosi');
                }
                
                const categoryServices = await response.json();
                
                document.getElementById('loadingServices').classList.add('hidden');
                servicesContainer.classList.remove('hidden');
                
                servicesContainer.innerHTML = '';
                categoryServices.forEach(service => {
                    const serviceElement = document.createElement('div');
                    serviceElement.className = 'service-card bg-white border border-gray-200 rounded-xl p-5 cursor-pointer';
                    serviceElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold text-gray-800">${service.name}</h3>
                                <p class="text-gray-600 text-sm mt-1">Narx: ${service.price.toLocaleString()} so'm</p>
                            </div>
                            <div class="w-10 h-10 bg-gradient-to-r from-green-100 to-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-chevron-right text-blue-500"></i>
                            </div>
                        </div>
                    `;
                    serviceElement.addEventListener('click', () => selectService(service, serviceElement));
                    servicesContainer.appendChild(serviceElement);
                });
            } catch (error) {
                console.error('Servislarni yuklashda xato:', error);
                document.getElementById('loadingServices').classList.add('hidden');
                document.getElementById('servicesError').classList.remove('hidden');
            }
        }

        // Servisni tanlash
        function selectService(service, element) {
            selectedService = service;
            
            // Barcha servislardan tanlanganini ajratib ko'rsatish
            document.querySelectorAll('.service-card').forEach(el => {
                el.classList.remove('selected', 'border-blue-500');
            });
            element.classList.add('selected', 'border-blue-500');
        }

        // Umumiy summani hisoblash
        function calculateTotal() {
            if (!selectedService) return;
            
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const total = quantity * selectedService.price;
            
            document.getElementById('total-amount').textContent = `${total.toLocaleString()} so'm`;
        }

        // Qadamlar orasida harakatlanish
        function goToStep2() {
            if (!selectedService) {
                showError('Iltimos, avval servis tanlang');
                return;
            }
            
            currentStep = 2;
            updateStepProgress();
            step1Content.classList.add('hidden');
            step2Content.classList.remove('hidden');
            
            // Tanlangan servis ma'lumotlarini ko'rsatish
            document.getElementById('selected-service-info').textContent = `${selectedService.name} (${selectedCategory})`;
            document.getElementById('selected-service-price').textContent = `${selectedService.price.toLocaleString()} so'm / birlik`;
            
            // Umumiy summani qayta hisoblash
            calculateTotal();
        }

        function goToStep3() {
            const profileUrl = document.getElementById('profileUrl').value;
            const quantity = document.getElementById('quantity').value;
            
            if (!profileUrl) {
                showError('Iltimos, profil manzilini kiriting');
                return;
            }
            
            if (!quantity || quantity < 1) {
                showError('Iltimos, miqdorni kiriting');
                return;
            }
            
            currentStep = 3;
            updateStepProgress();
            step2Content.classList.add('hidden');
            step3Content.classList.remove('hidden');
            
            // Buyurtma xulosasini ko'rsatish
            const total = parseInt(quantity) * selectedService.price;
            document.getElementById('order-summary').textContent = `${selectedService.name} (${selectedCategory}) - ${quantity} birlik`;
            document.getElementById('order-total').textContent = `${total.toLocaleString()} so'm`;
        }

        function goToStep1() {
            currentStep = 1;
            updateStepProgress();
            step2Content.classList.add('hidden');
            step1Content.classList.remove('hidden');
        }

        function goToStep2FromStep3() {
            currentStep = 2;
            updateStepProgress();
            step3Content.classList.add('hidden');
            step2Content.classList.remove('hidden');
        }

        // Progress chizig'ini yangilash
        function updateStepProgress() {
            // Progress chizig'i
            const progressWidth = ((currentStep - 1) / 2) * 100;
            progressLine.style.width = `${progressWidth}%`;
            
            // Qadam indikatorlari
            document.querySelectorAll('.step-progress').forEach((step, index) => {
                const stepNumber = index + 1;
                if (stepNumber < currentStep) {
                    step.classList.remove('step-active', 'bg-gray-200');
                    step.classList.add('step-completed');
                } else if (stepNumber === currentStep) {
                    step.classList.remove('step-completed', 'bg-gray-200');
                    step.classList.add('step-active');
                } else {
                    step.classList.remove('step-active', 'step-completed');
                    step.classList.add('bg-gray-200');
                }
            });
        }

        // Buyurtmani yuborish
        async function submitOrder() {
            const profileUrl = document.getElementById('profileUrl').value;
            const quantity = document.getElementById('quantity').value;
            const paymentScreenshotInput = document.getElementById('paymentScreenshot');
            
            if (!paymentScreenshotInput.files.length) {
                showError('Iltimos, to\'lov skrinshotini yuklang');
                return;
            }
            
            // Tugmani yuklanish holatiga o'tkazish
            const originalText = submitOrderBtn.innerHTML;
            submitOrderBtn.innerHTML = '<div class="loading mr-2"></div> Yuklanmoqda...';
            submitOrderBtn.disabled = true;
            
            // Rasmni base64 ga o'tkazish
            const file = paymentScreenshotInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(event) {
                const paymentScreenshot = event.target.result;
                const total = parseInt(quantity) * selectedService.price;
                
                try {
                    const response = await fetch('https://nakrutka-uz.onrender.com/api/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            category: selectedCategory,
                            service: selectedService.name,
                            profileUrl: profileUrl,
                            quantity: parseInt(quantity),
                            amount: total,
                            paymentScreenshot: paymentScreenshot
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successModal.classList.remove('hidden');
                    } else {
                        showError('Buyurtma yuborishda xato: ' + result.error);
                    }
                } catch (error) {
                    console.error('Buyurtma yuborish xatosi:', error);
                    showError('Buyurtma yuborishda xato yuz berdi');
                } finally {
                    // Tugmani qayta tiklash
                    submitOrderBtn.innerHTML = originalText;
                    submitOrderBtn.disabled = false;
                }
            };
            
            reader.readAsDataURL(file);
        }

        // Tarixni ko'rsatish
        async function showHistory() {
            try {
                historyModal.classList.remove('hidden');
                document.getElementById('loadingHistory').classList.remove('hidden');
                document.getElementById('historyList').classList.add('hidden');
                document.getElementById('historyError').classList.add('hidden');

                const response = await fetch('https://nakrutka-uz.onrender.com/api/orders');
                if (!response.ok) {
                    throw new Error('Server xatosi');
                }
                
                const orders = await response.json();
                
                document.getElementById('loadingHistory').classList.add('hidden');
                document.getElementById('historyList').classList.remove('hidden');
                
                const historyList = document.getElementById('historyList');
                
                if (orders.length === 0) {
                    historyList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-inbox text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-500">Hali buyurtmalar mavjud emas</p>
                        </div>
                    `;
                } else {
                    historyList.innerHTML = orders.map(order => `
                        <div class="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-lg text-gray-800">${order.service} (${order.category})</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                                        <p class="text-sm text-gray-600 flex items-center">
                                            <i class="fas fa-link text-blue-500 mr-2"></i> 
                                            ${order.profileUrl}
                                        </p>
                                        <p class="text-sm text-gray-600 flex items-center">
                                            <i class="fas fa-hashtag text-purple-500 mr-2"></i> 
                                            Miqdor: ${order.quantity} birlik
                                        </p>
                                        <p class="text-sm text-gray-600 flex items-center">
                                            <i class="fas fa-money-bill-wave text-green-500 mr-2"></i> 
                                            Umumiy: ${order.amount.toLocaleString()} so'm
                                        </p>
                                        <p class="text-sm text-gray-600 flex items-center">
                                            <i class="fas fa-calendar text-orange-500 mr-2"></i> 
                                            Sana: ${new Date(order.createdAt).toLocaleDateString('uz-UZ')}
                                        </p>
                                    </div>
                                </div>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${
                                    order.status === 'approved' ? 'bg-green-100 text-green-800' :
                                    order.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                    'bg-yellow-100 text-yellow-800'
                                } ml-4">
                                    ${order.status === 'approved' ? 'Tasdiqlangan' :
                                      order.status === 'rejected' ? 'Rad etilgan' : 'Kutilmoqda'}
                                </span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Tarixni yuklash xatosi:', error);
                document.getElementById('loadingHistory').classList.add('hidden');
                document.getElementById('historyError').classList.remove('hidden');
            }
        }

        // Xatolikni ko'rsatish
        function showError(message) {
            // Soddalashtirilgan xato ko'rsatish
            alert(message);
        }

        // Formani qayta tiklash
        function resetForm() {
            currentStep = 1;
            selectedCategory = null;
            selectedService = null;
            
            updateStepProgress();
            step3Content.classList.add('hidden');
            step2Content.classList.add('hidden');
            step1Content.classList.remove('hidden');
            
            servicesSection.classList.add('hidden');
            nextToStep2Btn.classList.add('hidden');
            
            document.getElementById('profileUrl').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('paymentScreenshot').value = '';
            document.getElementById('preview-container').classList.add('hidden');
            
            // Tanlangan servislarni qayta tiklash
            document.querySelectorAll('.service-card').forEach(el => {
                el.classList.remove('selected', 'border-blue-500');
            });
            
            document.querySelectorAll('#categories > div').forEach(el => {
                el.classList.remove('border-blue-500', 'bg-blue-50');
            });
        }
    </script>
</body>
</html>
