<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Nakrutka Servislari</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }
        
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        
        @keyframes modalEnter {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-5 shadow-xl">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    <i class="fas fa-shield-alt text-purple-600 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">Admin Panel</h1>
                    <p class="text-blue-100 text-sm">Nakrutka Servislari Boshqaruvi</p>
                </div>
            </div>
            <div class="flex space-x-3">
                <button id="ordersTab" class="bg-white text-purple-600 hover:bg-purple-50 px-6 py-3 rounded-xl transition-all duration-300 font-semibold shadow-lg hover:shadow-xl flex items-center space-x-2 tab-active">
                    <i class="fas fa-list"></i>
                    <span>Buyurtmalar</span>
                </button>
                <button id="servicesTab" class="bg-white text-purple-600 hover:bg-purple-50 px-6 py-3 rounded-xl transition-all duration-300 font-semibold shadow-lg hover:shadow-xl flex items-center space-x-2">
                    <i class="fas fa-cogs"></i>
                    <span>Servislar</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stats-card rounded-2xl p-6 text-center card-hover">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-shopping-cart text-xl"></i>
                </div>
                <h3 class="text-3xl font-bold" id="totalOrders">0</h3>
                <p class="text-blue-100">Jami Buyurtmalar</p>
            </div>
            <div class="stats-card rounded-2xl p-6 text-center card-hover">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-clock text-xl"></i>
                </div>
                <h3 class="text-3xl font-bold" id="pendingOrders">0</h3>
                <p class="text-blue-100">Kutilayotgan</p>
            </div>
            <div class="stats-card rounded-2xl p-6 text-center card-hover">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <h3 class="text-3xl font-bold" id="approvedOrders">0</h3>
                <p class="text-blue-100">Tasdiqlangan</p>
            </div>
            <div class="stats-card rounded-2xl p-6 text-center card-hover">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-times-circle text-xl"></i>
                </div>
                <h3 class="text-3xl font-bold" id="rejectedOrders">0</h3>
                <p class="text-blue-100">Rad Etilgan</p>
            </div>
        </div>

        <!-- Tab: Buyurtmalar -->
        <div id="ordersContent" class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-list-alt text-blue-500 mr-3"></i>
                    Buyurtmalarni Boshqarish
                </h2>
                <div class="flex space-x-2 bg-gray-100 p-1 rounded-xl">
                    <button id="filterAll" class="px-4 py-2 rounded-lg bg-blue-500 text-white font-medium transition-all">Hammasi</button>
                    <button id="filterPending" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-white font-medium transition-all">Kutilmoqda</button>
                    <button id="filterApproved" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-white font-medium transition-all">Tasdiqlangan</button>
                    <button id="filterRejected" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-white font-medium transition-all">Rad Etilgan</button>
                </div>
            </div>
            
            <div class="overflow-x-auto rounded-xl border border-gray-200">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gradient-to-r from-blue-500 to-purple-500 text-white">
                            <th class="py-4 px-6 text-left font-semibold">ID</th>
                            <th class="py-4 px-6 text-left font-semibold">Servis</th>
                            <th class="py-4 px-6 text-left font-semibold">Profil Manzili</th>
                            <th class="py-4 px-6 text-left font-semibold">Miqdor</th>
                            <th class="py-4 px-6 text-left font-semibold">Summa</th>
                            <th class="py-4 px-6 text-left font-semibold">Holat</th>
                            <th class="py-4 px-6 text-left font-semibold">Sana</th>
                            <th class="py-4 px-6 text-left font-semibold">Harakatlar</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Buyurtma ma'lumotlari dinamik ravishda yuklanadi -->
                    </tbody>
                </table>
            </div>
            
            <div id="ordersEmpty" class="text-center py-12 hidden">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-inbox text-gray-400 text-3xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Buyurtmalar Topilmadi</h3>
                <p class="text-gray-500">Hozircha hech qanday buyurtma mavjud emas</p>
            </div>

            <div id="ordersLoading" class="text-center py-12">
                <div class="loading mx-auto mb-3"></div>
                <p class="text-gray-500">Buyurtmalar yuklanmoqda...</p>
            </div>
        </div>

        <!-- Tab: Servislar -->
        <div id="servicesContent" class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-cogs text-purple-500 mr-3"></i>
                    Servislarni Boshqarish
                </h2>
                <button id="addServiceBtn" class="btn-success text-white px-6 py-3 rounded-xl font-semibold flex items-center space-x-2 pulse-animation">
                    <i class="fas fa-plus"></i>
                    <span>Yangi Servis</span>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="servicesList">
                <!-- Servis kartalari dinamik ravishda yuklanadi -->
            </div>
            
            <div id="servicesEmpty" class="text-center py-12 hidden">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-cogs text-gray-400 text-3xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Servislar Topilmadi</h3>
                <p class="text-gray-500">Birorta servis mavjud emas</p>
                <button id="addFirstService" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold mt-4">
                    <i class="fas fa-plus mr-2"></i>Birinchi Servisni Qo'shing
                </button>
            </div>

            <div id="servicesLoading" class="text-center py-12">
                <div class="loading mx-auto mb-3"></div>
                <p class="text-gray-500">Servislar yuklanmoqda...</p>
            </div>
        </div>
    </main>

    <!-- Modal: Buyurtma Tafsilotlari -->
    <div id="orderDetailModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden modal-enter">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-gradient-to-r from-blue-500 to-purple-500 text-white">
                <h3 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-info-circle mr-3"></i>
                    Buyurtma Tafsilotlari
                </h3>
                <button id="closeOrderDetailModal" class="text-white hover:text-gray-200 text-xl transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div id="orderDetailContent">
                    <!-- Buyurtma tafsilotlari dinamik ravishda yuklanadi -->
                </div>
            </div>
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50">
                <button id="rejectOrderBtn" class="btn-danger text-white px-6 py-3 rounded-xl font-semibold flex items-center space-x-2">
                    <i class="fas fa-times"></i>
                    <span>Rad Etish</span>
                </button>
                <button id="approveOrderBtn" class="btn-success text-white px-6 py-3 rounded-xl font-semibold flex items-center space-x-2">
                    <i class="fas fa-check"></i>
                    <span>Tasdiqlash</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Servis Qo'shish/Tahrirlash -->
    <div id="serviceModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 modal-enter">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="serviceModalTitle">Yangi Servis Qo'shish</h3>
                <button id="closeServiceModal" class="text-gray-500 hover:text-gray-700 text-xl transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="serviceForm">
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-layer-group text-blue-500 mr-2"></i>
                            Kategoriya
                        </label>
                        <input type="text" id="serviceCategory" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Masalan: Instagram" required>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-tag text-purple-500 mr-2"></i>
                            Servis Nomi
                        </label>
                        <input type="text" id="serviceName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Masalan: Obunalar" required>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-money-bill-wave text-green-500 mr-2"></i>
                            Narx (so'm)
                        </label>
                        <input type="number" id="servicePrice" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="1000" min="1" required>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelServiceBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-xl font-semibold transition-all duration-300">
                        Bekor Qilish
                    </button>
                    <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold flex items-center space-x-2">
                        <i class="fas fa-save"></i>
                        <span>Saqlash</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Dastur holati
        let currentTab = 'orders';
        let ordersData = [];
        let servicesData = [];
        let currentOrderId = null;
        let currentServiceId = null;

        // DOM Elementlari
        const ordersTab = document.getElementById('ordersTab');
        const servicesTab = document.getElementById('servicesTab');
        const ordersContent = document.getElementById('ordersContent');
        const servicesContent = document.getElementById('servicesContent');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const ordersEmpty = document.getElementById('ordersEmpty');
        const ordersLoading = document.getElementById('ordersLoading');
        const servicesList = document.getElementById('servicesList');
        const servicesEmpty = document.getElementById('servicesEmpty');
        const servicesLoading = document.getElementById('servicesLoading');
        const orderDetailModal = document.getElementById('orderDetailModal');
        const closeOrderDetailModal = document.getElementById('closeOrderDetailModal');
        const orderDetailContent = document.getElementById('orderDetailContent');
        const rejectOrderBtn = document.getElementById('rejectOrderBtn');
        const approveOrderBtn = document.getElementById('approveOrderBtn');
        const serviceModal = document.getElementById('serviceModal');
        const closeServiceModal = document.getElementById('closeServiceModal');
        const serviceModalTitle = document.getElementById('serviceModalTitle');
        const serviceForm = document.getElementById('serviceForm');
        const cancelServiceBtn = document.getElementById('cancelServiceBtn');
        const addServiceBtn = document.getElementById('addServiceBtn');
        const addFirstService = document.getElementById('addFirstService');
        const filterAll = document.getElementById('filterAll');
        const filterPending = document.getElementById('filterPending');
        const filterApproved = document.getElementById('filterApproved');
        const filterRejected = document.getElementById('filterRejected');

        // Statistikalar elementlari
        const totalOrders = document.getElementById('totalOrders');
        const pendingOrders = document.getElementById('pendingOrders');
        const approvedOrders = document.getElementById('approvedOrders');
        const rejectedOrders = document.getElementById('rejectedOrders');

        // Event Listenerlar
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();
            loadServices();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Tab navigatsiyasi
            ordersTab.addEventListener('click', () => switchTab('orders'));
            servicesTab.addEventListener('click', () => switchTab('services'));
            
            // Buyurtma harakatlari
            closeOrderDetailModal.addEventListener('click', () => orderDetailModal.classList.add('hidden'));
            rejectOrderBtn.addEventListener('click', () => updateOrderStatus('rejected'));
            approveOrderBtn.addEventListener('click', () => updateOrderStatus('approved'));
            
            // Servis harakatlari
            closeServiceModal.addEventListener('click', () => serviceModal.classList.add('hidden'));
            cancelServiceBtn.addEventListener('click', () => serviceModal.classList.add('hidden'));
            addServiceBtn.addEventListener('click', () => openServiceModal());
            addFirstService.addEventListener('click', () => openServiceModal());
            serviceForm.addEventListener('submit', saveService);
            
            // Filtrlash
            filterAll.addEventListener('click', () => filterOrders('all'));
            filterPending.addEventListener('click', () => filterOrders('pending'));
            filterApproved.addEventListener('click', () => filterOrders('approved'));
            filterRejected.addEventListener('click', () => filterOrders('rejected'));
        }

        // Tabni o'zgartirish
        function switchTab(tab) {
            currentTab = tab;
            
            // Aktiv tabni yangilash
            ordersTab.classList.remove('tab-active');
            servicesTab.classList.remove('tab-active');
            
            if (tab === 'orders') {
                ordersTab.classList.add('tab-active');
                ordersContent.classList.remove('hidden');
                servicesContent.classList.add('hidden');
            } else {
                servicesTab.classList.add('tab-active');
                ordersContent.classList.add('hidden');
                servicesContent.classList.remove('hidden');
            }
        }

        // Buyurtmalarni yuklash
        async function loadOrders() {
            try {
                ordersLoading.classList.remove('hidden');
                ordersEmpty.classList.add('hidden');
                ordersTableBody.innerHTML = '';

                const response = await fetch('/api/admin/orders');
                if (!response.ok) {
                    throw new Error('Server xatosi');
                }
                
                ordersData = await response.json();
                renderOrders(ordersData);
                updateStatistics();
                
                ordersLoading.classList.add('hidden');
            } catch (error) {
                console.error('Buyurtmalarni yuklash xatosi:', error);
                ordersLoading.classList.add('hidden');
                ordersEmpty.classList.remove('hidden');
                ordersEmpty.innerHTML = `
                    <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Xato Yuz Berdi</h3>
                    <p class="text-gray-500 mb-4">Buyurtmalarni yuklashda xato yuz berdi</p>
                    <button onclick="loadOrders()" class="bg-blue-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-600 transition">
                        Qayta Urinish
                    </button>
                `;
            }
        }

        // Buyurtmalarni ko'rsatish
        function renderOrders(orders) {
            if (orders.length === 0) {
                ordersTableBody.innerHTML = '';
                ordersEmpty.classList.remove('hidden');
                return;
            }
            
            ordersEmpty.classList.add('hidden');
            ordersTableBody.innerHTML = orders.map(order => `
                <tr class="border-b border-gray-200 hover:bg-blue-50 transition-colors">
                    <td class="py-4 px-6 font-mono text-sm text-gray-600">${order._id.substring(0, 8)}...</td>
                    <td class="py-4 px-6">
                        <div>
                            <p class="font-semibold text-gray-800">${order.service}</p>
                            <p class="text-sm text-gray-500">${order.category}</p>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <p class="text-sm text-blue-600 truncate max-w-xs" title="${order.profileUrl}">${order.profileUrl}</p>
                    </td>
                    <td class="py-4 px-6">
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">${order.quantity}</span>
                    </td>
                    <td class="py-4 px-6 font-semibold text-green-600">${order.amount.toLocaleString()} so'm</td>
                    <td class="py-4 px-6">
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${
                            order.status === 'approved' ? 'bg-green-100 text-green-800' :
                            order.status === 'rejected' ? 'bg-red-100 text-red-800' :
                            'bg-yellow-100 text-yellow-800'
                        }">
                            ${order.status === 'approved' ? 'Tasdiqlangan' :
                              order.status === 'rejected' ? 'Rad Etilgan' : 'Kutilmoqda'}
                        </span>
                    </td>
                    <td class="py-4 px-6 text-sm text-gray-600">${new Date(order.createdAt).toLocaleDateString('uz-UZ')}</td>
                    <td class="py-4 px-6">
                        <button class="view-order-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors font-medium" data-id="${order._id}">
                            <i class="fas fa-eye mr-1"></i> Ko'rish
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Ko'rish tugmalariga event listener qo'shish
            document.querySelectorAll('.view-order-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderId = e.currentTarget.getAttribute('data-id');
                    showOrderDetail(orderId);
                });
            });
        }

        // Statistikani yangilash
        function updateStatistics() {
            const total = ordersData.length;
            const pending = ordersData.filter(order => order.status === 'pending').length;
            const approved = ordersData.filter(order => order.status === 'approved').length;
            const rejected = ordersData.filter(order => order.status === 'rejected').length;
            
            totalOrders.textContent = total;
            pendingOrders.textContent = pending;
            approvedOrders.textContent = approved;
            rejectedOrders.textContent = rejected;
        }

        // Buyurtmalarni filtrlash
        function filterOrders(status) {
            let filteredOrders = ordersData;
            
            if (status !== 'all') {
                filteredOrders = ordersData.filter(order => order.status === status);
            }
            
            // Filtr tugmalarini yangilash
            filterAll.classList.remove('bg-blue-500', 'text-white');
            filterPending.classList.remove('bg-blue-500', 'text-white');
            filterApproved.classList.remove('bg-blue-500', 'text-white');
            filterRejected.classList.remove('bg-blue-500', 'text-white');
            
            filterAll.classList.add('text-gray-600', 'hover:bg-white');
            filterPending.classList.add('text-gray-600', 'hover:bg-white');
            filterApproved.classList.add('text-gray-600', 'hover:bg-white');
            filterRejected.classList.add('text-gray-600', 'hover:bg-white');
            
            document.getElementById(`filter${status.charAt(0).toUpperCase() + status.slice(1)}`).classList.remove('text-gray-600', 'hover:bg-white');
            document.getElementById(`filter${status.charAt(0).toUpperCase() + status.slice(1)}`).classList.add('bg-blue-500', 'text-white');
            
            renderOrders(filteredOrders);
        }

        // Buyurtma tafsilotlarini ko'rsatish
        async function showOrderDetail(orderId) {
            try {
                const order = ordersData.find(o => o._id === orderId);
                if (!order) return;
                
                currentOrderId = orderId;
                
                orderDetailContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                    Asosiy Ma'lumotlar
                                </h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">ID:</span>
                                        <span class="font-mono text-sm">${order._id}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Session ID:</span>
                                        <span class="font-mono text-sm">${order.sessionId}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Kategoriya:</span>
                                        <span class="font-semibold">${order.category}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Servis:</span>
                                        <span class="font-semibold">${order.service}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-calculator text-green-500 mr-2"></i>
                                    To'lov Ma'lumotlari
                                </h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Miqdor:</span>
                                        <span class="font-semibold">${order.quantity} birlik</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Narx:</span>
                                        <span class="font-semibold">${order.amount.toLocaleString()} so'm</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Holat:</span>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                            order.status === 'approved' ? 'bg-green-100 text-green-800' :
                                            order.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                            'bg-yellow-100 text-yellow-800'
                                        }">
                                            ${order.status === 'approved' ? 'Tasdiqlangan' :
                                              order.status === 'rejected' ? 'Rad Etilgan' : 'Kutilmoqda'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Sana:</span>
                                        <span class="font-semibold">${new Date(order.createdAt).toLocaleString('uz-UZ')}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-link text-purple-500 mr-2"></i>
                                Profil Manzili
                            </h4>
                            <p class="text-blue-600 break-all">${order.profileUrl}</p>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-receipt text-orange-500 mr-2"></i>
                                To'lov Skrinshoti
                            </h4>
                            <div class="mt-2 flex justify-center">
                                <img src="${order.paymentScreenshot}" alt="To'lov skrinshoti" class="max-w-full h-auto rounded-xl border-2 border-gray-300 shadow-md">
                            </div>
                        </div>
                    </div>
                `;
                
                // Harakat tugmalarini holatiga qarab sozlash
                if (order.status === 'pending') {
                    rejectOrderBtn.classList.remove('hidden');
                    approveOrderBtn.classList.remove('hidden');
                } else {
                    rejectOrderBtn.classList.add('hidden');
                    approveOrderBtn.classList.add('hidden');
                }
                
                orderDetailModal.classList.remove('hidden');
            } catch (error) {
                console.error('Buyurtma tafsilotlarini ko\'rsatish xatosi:', error);
            }
        }

        // Buyurtma holatini yangilash
        async function updateOrderStatus(status) {
            try {
                const response = await fetch(`/api/admin/orders/${currentOrderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    orderDetailModal.classList.add('hidden');
                    loadOrders(); // Buyurtmalarni qayta yuklash
                } else {
                    alert('Buyurtma holatini yangilashda xato');
                }
            } catch (error) {
                console.error('Buyurtma holatini yangilash xatosi:', error);
                alert('Buyurtma holatini yangilashda xato yuz berdi');
            }
        }

        // Servislarni yuklash
        async function loadServices() {
            try {
                servicesLoading.classList.remove('hidden');
                servicesEmpty.classList.add('hidden');
                servicesList.innerHTML = '';

                const response = await fetch('/api/admin/services');
                if (!response.ok) {
                    throw new Error('Server xatosi');
                }
                
                servicesData = await response.json();
                renderServices(servicesData);
                
                servicesLoading.classList.add('hidden');
            } catch (error) {
                console.error('Servislarni yuklash xatosi:', error);
                servicesLoading.classList.add('hidden');
                servicesEmpty.classList.remove('hidden');
            }
        }

        // Servislarni ko'rsatish
        function renderServices(services) {
            if (services.length === 0) {
                servicesList.innerHTML = '';
                servicesEmpty.classList.remove('hidden');
                return;
            }
            
            servicesEmpty.classList.add('hidden');
            servicesList.innerHTML = services.map(service => `
                <div class="bg-white border border-gray-200 rounded-2xl p-6 card-hover">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-xl text-gray-800 mb-1">${service.name}</h3>
                            <p class="text-gray-600 flex items-center">
                                <i class="fas fa-layer-group text-blue-500 mr-2"></i>
                                ${service.category}
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-service-btn bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition-colors" data-id="${service._id}" title="Tahrirlash">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-service-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition-colors" data-id="${service._id}" title="O'chirish">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-xl border border-green-200">
                        <p class="text-2xl font-bold text-green-600 text-center">${service.price.toLocaleString()} so'm</p>
                    </div>
                    <p class="text-sm text-gray-500 mt-3 text-center">${new Date(service.createdAt).toLocaleDateString('uz-UZ')} da qo'shilgan</p>
                </div>
            `).join('');
            
            // Tahrirlash va o'chirish tugmalariga event listener qo'shish
            document.querySelectorAll('.edit-service-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const serviceId = e.currentTarget.getAttribute('data-id');
                    openServiceModal(serviceId);
                });
            });
            
            document.querySelectorAll('.delete-service-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const serviceId = e.currentTarget.getAttribute('data-id');
                    deleteService(serviceId);
                });
            });
        }

        // Servis modalini ochish
        function openServiceModal(serviceId = null) {
            currentServiceId = serviceId;
            
            if (serviceId) {
                // Tahrirlash rejimi
                serviceModalTitle.textContent = 'Servisni Tahrirlash';
                const service = servicesData.find(s => s._id === serviceId);
                document.getElementById('serviceCategory').value = service.category;
                document.getElementById('serviceName').value = service.name;
                document.getElementById('servicePrice').value = service.price;
            } else {
                // Qo'shish rejimi
                serviceModalTitle.textContent = 'Yangi Servis Qo\'shish';
                document.getElementById('serviceCategory').value = '';
                document.getElementById('serviceName').value = '';
                document.getElementById('servicePrice').value = '';
            }
            
            serviceModal.classList.remove('hidden');
        }

        // Servisni saqlash
        async function saveService(e) {
            e.preventDefault();
            
            const category = document.getElementById('serviceCategory').value;
            const name = document.getElementById('serviceName').value;
            const price = parseInt(document.getElementById('servicePrice').value);
            
            try {
                let response;
                
                if (currentServiceId) {
                    // Mavjud servisni yangilash
                    response = await fetch(`/api/admin/services/${currentServiceId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ category, name, price })
                    });
                } else {
                    // Yangi servis qo'shish
                    response = await fetch('/api/admin/services', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ category, name, price })
                    });
                }
                
                const result = await response.json();
                
                if (result.success) {
                    serviceModal.classList.add('hidden');
                    loadServices(); // Servislarni qayta yuklash
                } else {
                    alert('Servisni saqlashda xato: ' + result.error);
                }
            } catch (error) {
                console.error('Servisni saqlash xatosi:', error);
                alert('Servisni saqlashda xato yuz berdi');
            }
        }

        // Servisni o'chirish
        async function deleteService(serviceId) {
            if (!confirm('Haqiqatan ham bu servisni o\'chirmoqchimisiz?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/services/${serviceId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadServices(); // Servislarni qayta yuklash
                } else {
                    alert('Servisni o\'chirishda xato');
                }
            } catch (error) {
                console.error('Servisni o\'chirish xatosi:', error);
                alert('Servisni o\'chirishda xato yuz berdi');
            }
        }
    </script>
</body>
</html>